(window.webpackJsonp=window.webpackJsonp||[]).push([["rest-broker"],{"24R9":function(t,e,s){"use strict";function i(t){return decodeURIComponent(t.replace(/\+/g," ")).replace(/<\/?[^>]+(>|$)/g,"")}function r(t){const e=/([^&=]+)=?([^&]*)/g,s={};if(!t)return s;let r=e.exec(t);for(;r;)s[i(r[1])]=i(r[2]),r=e.exec(t);return s}function o(){return r(window.location.search.substring(1))}function n(t){const e=[];for(const s in t)t.hasOwnProperty(s)&&null!=t[s]&&e.push({key:s,pair:encodeURIComponent(s)+"="+encodeURIComponent(t[s])});return e.sort((t,e)=>t.key>e.key?1:t.key<e.key?-1:0).map(t=>t.pair).join("&")}s.d(e,"b",(function(){return o})),s.d(e,"a",(function(){return n}))},"3+Gi":function(t,e,s){"use strict";var i;s.d(e,"a",(function(){return i})),function(t){t[t.StopLoss=0]="StopLoss",t[t.TrailingStop=1]="TrailingStop"}(i||(i={}))},E9hm:function(t,e,s){"use strict";s.r(e),s.d(e,"defaultConfigFlags",(function(){return i})),s.d(e,"applyDefaultsToConfigFlags",(function(){return r}));const i={isSuspended:!1,supportDemoLiveSwitcher:!0,supportEditAmount:!0,supportMarketBrackets:!0,supportMarketOrders:!0,supportStopOrders:!0,supportLimitOrders:!0,supportStopLimitOrders:!1,supportPositions:!0,supportDOM:!0,supportModifyOrder:!0,supportModifyTrailingStop:!0,supportAddBracketsToExistingOrder:!0,supportVerifyLiveAccount:!0,supportReversePosition:!0,showNotificationsLog:!0,supportPLUpdate:!0,supportTwoFactorAuthorization:!1,supportDisplayBrokerNameInSymbolSearch:!0,supportCurrencyInOrderPreview:!0,supportRiskControls:!0};function r(t){return Object.assign({},i,t)}},LRNa:function(t,e,s){"use strict";s.r(e);var i=s("YFKU"),r=s("Eyy1"),o=s("ivNn"),n=(s("bSeV"),s("3+Gi")),a=s("JES+");s("25b6");const c=[{label:Object(i.t)("Symbol"),formatter:"symbol",showLabelOnMobile:!1,property:"brokerSymbol",notHideable:!0},{label:Object(i.t)("Side"),property:"side",formatter:"side"},{label:Object(i.t)("Type"),property:"type",formatter:"type"},{label:Object(i.t)("Qty"),alignment:"right",property:"qty",formatter:"formatQuantity",help:Object(i.t)("Size in lots")},{label:Object(i.t)("Filled Qty"),alignment:"right",property:"filledQty",formatter:"formatQuantity",help:Object(i.t)("Filled Size in lots")},{label:Object(i.t)("Limit Price"),alignment:"right",property:"limitPrice",formatter:"formatPrice"},{label:Object(i.t)("Stop Price"),alignment:"right",property:"stopPrice",formatter:"formatPrice"},{label:Object(i.t)("Take Profit"),alignment:"right",property:"takeProfit",formatter:"formatPrice"},{label:Object(i.t)("Stop Loss"),alignment:"right",property:"stopLoss",formatter:"formatPrice"},{label:Object(i.t)("Trailing Stop"),alignment:"right",property:"trailingStopPrice",formatter:"formatPrice"},{label:Object(i.t)("Avg Fill Price"),alignment:"right",property:"avgPrice",formatter:"formatPrice",supportedStatusFilters:[0,6,2]},{label:Object(i.t)("Status"),property:"status",formatter:"status",supportedStatusFilters:[0]},{label:Object(i.t)("Update Time"),property:"updateTime",formatter:"localDate"},{label:Object(i.t)("Order id"),property:"id"},{
label:Object(i.t)("Expiry"),property:"expiry"},{label:Object(i.t)("Expiry Time"),alignment:"right",property:"expiryTime",formatter:"localDateOrDateTime"}],u=[{label:Object(i.t)("Symbol"),formatter:"symbol",showLabelOnMobile:!1,property:"brokerSymbol",notHideable:!0},{label:Object(i.t)("Side"),property:"side",formatter:"side"},{label:Object(i.t)("Type"),property:"type",formatter:"type"},{label:Object(i.t)("Qty"),alignment:"right",property:"qty",formatter:"formatQuantity",help:Object(i.t)("Size in lots")},{label:Object(i.t)("Filled Qty"),alignment:"right",property:"filledQty",formatter:"formatQuantity",help:Object(i.t)("Filled Size in lots")},{label:Object(i.t)("Limit Price"),alignment:"right",property:"limitPrice",formatter:"formatPrice"},{label:Object(i.t)("Stop Price"),alignment:"right",property:"stopPrice",formatter:"formatPrice"},{label:Object(i.t)("Avg Fill Price"),alignment:"right",property:"avgPrice",formatter:"formatPrice"},{label:Object(i.t)("Status"),property:"status",formatter:"status"},{label:Object(i.t)("Update Time"),property:"updateTime",formatter:"localDate"},{label:Object(i.t)("Order id"),property:"id"}],l=(Object(i.t)("Balance"),Object(i.t)("Equity",{context:"trading"}),Object(i.t)("Total Profit"),[{label:Object(i.t)("Symbol"),formatter:"symbol",showLabelOnMobile:!1,property:"brokerSymbol",notHideable:!0},{label:Object(i.t)("Side"),property:"side",formatter:"positionSide"},{label:Object(i.t)("Qty"),alignment:"right",property:"qty",formatter:"formatQuantity",help:Object(i.t)("Size in lots")},{label:Object(i.t)("Avg Fill Price"),alignment:"right",property:"avgPrice",formatter:"avgPriceFormatter"},{label:Object(i.t)("Take Profit"),alignment:"right",property:"takeProfit",formatter:"formatPriceForexSup"},{label:Object(i.t)("Stop Loss"),alignment:"right",property:"stopLoss",formatter:"formatPriceForexSup"},{label:Object(i.t)("Trailing Stop"),alignment:"right",property:"trailingStopPrice",formatter:"formatPriceForexSup"},{label:Object(i.t)("Profit"),alignment:"right",property:"unrealizedPl",formatter:"profitInInstrumentCurrency",isCapitalize:!1},{label:Object(i.t)("Position id"),property:"id"}]),h=[{label:Object(i.t)("Symbol"),property:"symbol"},{label:Object(i.t)("Currency name"),property:"longName",notSortable:!0},{label:Object(i.t)("Total"),alignment:"right",property:"total",formatter:"variablePrecision"},{label:Object(i.t)("Available"),alignment:"right",property:"available",formatter:"variablePrecision"},{label:Object(i.t)("Reserved"),alignment:"right",property:"reserved",formatter:"variablePrecision"},{label:Object(i.t)("BTC value"),alignment:"right",property:"btcValue",formatter:"variablePrecision"},{label:Object(i.t)("Value"),property:"value",alignment:"right",formatter:"cryptoValueInCurrencyFormatter"}];var d=s("0W4x"),p=s("/udZ"),_=s("24R9");s("bZMm");const g=window.t("Failed to fetch");var m;function y(t){const e={Accept:"application/json","Content-Type":"application/x-www-form-urlencoded",Referer:"https://www.tradingview.com/chart/OlHDdzUm/"};return t&&(e.Authorization="Bearer "+t),e}
async function f(t,e,s=m.Get,i,r){const o=await async function(t,e,s=m.Get,i,r){const o=i?Object(_.a)(i):i,n={method:m[s],headers:y(e)};o&&s!==m.Get&&(n.body=o);try{const e=await fetch(t,n);if(!e.ok)throw new Error(e.statusText);return e}catch(t){throw t.message=Object(p.b)(t),r&&r.logError(t.message),t}}(t,e,s,i,r),n=await o.json();if(!function(t){return!(!t||t.hasOwnProperty("s")&&"error"===t.s)}(n)){const t=n.errmsg?n.errmsg:g;throw r&&r.logError(t),new Error(t)}return n}async function b(t,e,s=m.Get,i,r){const o=await f(t,e,s,i,r);return"d"in o?o.d:o}function P(t,e){return{login:t,password:e,locale:window.locale}}function O(t){return{valid:!0,data:t}}async function S(t,e,s,i,r=O,o){const n={method:m[e],headers:s};try{null!==i&&(n.body=JSON.stringify(i));const e=await fetch(t,n);if(!e.ok){if(void 0!==o){const t=await o(e);throw new p.a({detailedErrorMessage:t.logMessage,userFriendlyMessage:t.userFriendlyMessage})}throw new Error(e.statusText)}const s=r(await e.json());if(!1===s.valid)throw new Error(s.errormsg);return s.data}catch(t){throw new p.a({detailedErrorMessage:t.message,userFriendlyMessage:t.userFriendlyMessage})}}!function(t){t[t.Get=1]="Get",t[t.Post=2]="Post",t[t.Put=3]="Put",t[t.Delete=4]="Delete"}(m||(m={}));var v=s("e3/o"),T=s("txPx"),k=s("aIyQ"),w=s.n(k);const C=Object(T.getLogger)("Trading.Requester");class F{constructor(t,e,s,i,r,o,n){this._currentPulseIndex=0,this._requestInterval=null,this._requestTimeOut=null,this._errorsCount=0,this._status=0,this._snapshot=!0,this._url=t,this._headers=s,this._method=e,this._body=i,this._requestInterval=r,this.update=new w.a,this.statusChanged=new w.a,this._extractResponseData=o,this._extractErrorMessage=n}start(){return this._status=1,this._errorsCount=0,this._currentPulseIndex++,this._request()}stop(){this._status=0,this._clearResetRequestTimeout()}pause(){this.stop()}unpause(){this.start()}status(){return this._status}changeUrl(t){Object(r.assert)(1!==this._status,"Cannot change URL: requester is running"),this._url=t}changeHeaders(t){Object(r.assert)(1!==this._status,"Cannot change headers: requester is running"),this._headers=t}async _request(){const t=this._currentPulseIndex;Object(r.assert)(1===this._status,"Unable to request: requester is inactive");try{const e=this._url,s=await S(this._url,this._method,this._headers,this._body,this._extractResponseData,this._extractErrorMessage);this._errorsCount=0,e===this._url&&1===this._status&&t===this._currentPulseIndex&&(this.update.fire(s,this._snapshot),this._snapshot=!1)}catch(e){C.logError(`${Object(p.c)(e)}: ${this._url}`),this._errorsCount++,t===this._currentPulseIndex&&this._failOnErrorsCount(Object(p.b)(e))}finally{null!==this._requestInterval&&1===this._status&&t===this._currentPulseIndex&&await this._makeNextRequest()}}_clearResetRequestTimeout(){null!==this._requestTimeOut&&(clearTimeout(this._requestTimeOut),this._requestTimeOut=null)}_failOnErrorsCount(t){this._errorsCount>20&&(this._clearResetRequestTimeout(),this._status=2,this.statusChanged.fire({requesterStatus:this._status,errorMessage:t}))}
async _makeNextRequest(){const t=this._currentPulseIndex;this._requestTimeOut=null,this._requestTimeOut=setTimeout(async()=>{t===this._currentPulseIndex&&await this._request()},this._requestInterval)}}class A{constructor(t,e,s,i,r,o,n,a,c,u){this.update=new w.a,this.statusChanged=new w.a,this._data=[],this._status=0,this._requester=new F(t,e,s,i,r,a,c),this._idField=o,this._keys=n,this._useDeepEquals=u}start(){return this._status=1,this._requester.update.subscribe(this,this._onNewData),this._requester.statusChanged.subscribe(this,this._onStatusChanged),this._requester.start()}stop(){this._status=0,this._requester.update.unsubscribe(this,this._onNewData),this._requester.statusChanged.unsubscribe(this,this._onStatusChanged),this._requester.stop(),delete this._requester}pause(){this._status=0,this._requester.stop()}unpause(){this._status=1,this._requester.start()}changeHeaders(t){this._requester.changeHeaders(t)}_onNewData(t,e){if(1!==this._status)return;const s=Object(d.c)(this._data,t,this._idField,this._keys,this._useDeepEquals);(s.added.length>0||s.modified.length>0||s.removed.length>0)&&(this._data=t,this.update.fire(s,e))}_onStatusChanged(t){this._status=t.requesterStatus,this.statusChanged.fire({requesterStatus:t.requesterStatus,errorMessage:t.errorMessage})}}var j=s("G3Rl");s.d(e,"Broker",(function(){return tt}));const q={limit:1,market:2,stop:3,stoplimit:4},D={1:"limit",2:"market",3:"stop",4:"stoplimit"},I={placing:4,inactive:3,working:6,rejected:5,filled:2,cancelled:1},B=["qty","status","filledQty","avgPrice","limitPrice","stopPrice","parentId","duration","customFields","message"],R=["instrument","qty","side","avgPrice","unrealizedPl","realizedPl","stopLoss","trailingStopPips","takeProfit","message"],E=["available","total","btcValue"],U={checked:!1,text:""},x={history:500,positions:1e3,quotes:500,orders:500,accountManager:500,balances:1e3},M={locale:window.locale},L=Object(i.t)("This market is not tradable with this brokerage account. Switch to another account and try again"),z=Object(i.t)("You can't trade this market with this brokerage account. Please switch over to a different market and have another try.");function V(t){return t.s&&"ok"!==t.s?{valid:!1,errormsg:t.errmsg}:{valid:!0,data:t.d}}function $(t){return q[t=t||"market"]}function Q(t){return"sell"===t?-1:1}function H(t){return void 0!==t.accountManager&&Array.isArray(t.accountManager)&&t.accountManager.length>0}function G(t){return t.amData&&Array.isArray(t.amData)&&t.amData.length>0?t.amData:function(t){const e=Object(d.d)(t.balance),s=Object(d.d)(t.unrealizedPl);return[[[e,void 0!==t.equity?Object(d.d)(t.equity):Object(d.d)(t.balance+t.unrealizedPl),s]]]}(t)}function W(t,e){const s=2!==e.status&&1!==e.status,i=s?e.limitPrice:void 0,r=s?e.trailingStopPips:void 0,o=s?e.stopPrice:void 0;3===e.type&&(e.stopType===n.a.TrailingStop?(delete t.stopLoss,t.trailingStopPips=r,t.trailingStopPrice=o):(delete t.trailingStopPips,t.stopLoss=o)),1===e.type&&(t.takeProfit=i)}function N(t){return t.map(t=>({price:t[0],volume:t[1]}))}function K(t){
return Object.assign({id:t.symbol},t)}function J(t){return t.map(t=>{const e=!t.mutable;return delete t.mutable,{...t,inputType:"ComboBox",preventModify:e}})}function Y(t,e){return e.filter(e=>!(e in t))}const Z=Object(i.t)("Accounts configuration is invalid"),X=Object(i.t)("Broker configuration is invalid");class tt{constructor(t,e,s,i=null,o){var n;if(this._accounts=[],this._accountManagerTablesData=[],this._accountManagerTablesDelegates=[],this._fetchedBrokerSymbols=new Set,this._cryptoBalances=[],this._oAuthAuthorizationProvider=null,this._requesters={},this._depthSubscriptions={},this._customFormatters=[],this._permittedSymbolSearchGroups=[],this._accessTokenExpirationTimeout=null,this._loginTasks=null,this._orderColumns=c,this._orderHistoryColumns=u,this._positionColumns=l,this._makeInstrumentOrderDialogCustomFieldsMemoized=Object(j.a)(this._makeInstrumentOrderDialogCustomFields,t=>t.concat(this.currentAccount())),this._makeAccountOrderDialogCustomFieldsMemoized=Object(j.a)(this._makeAccountOrderDialogCustomFields,()=>this.currentAccount()),this._profitlossEmitters=new Map,this._reconnectOnFailCount=1,this._host=t,this._fastRenewOauthToken=o,this._restUrl=n="/"===(n=e)[n.length-1]?n:n+"/",this._metainfo=s,this._realtimeSubscriptions=new Set,this._pipValueSubscriptions=new Set,this._quotesSubscriptions=new Map,this._currentQuotes=new Map,this._priceFormatterCache=new Map,this._instruments=new Map,this._initData(),this._tokenStorageKey=String("rest-token"),this._permittedSymbolSearchGroups=[Object(r.ensureDefined)(s.id)],this._lastAccountIdKey=String("rest-last-account-id-"+s.id),this._logger=t.getLogger(),this._status=this._host.factory.createWatchedValue(3),this._account=t.factory.createWatchedValue({id:"",name:"",currencySign:"",config:{},instruments:[],type:a.AccountType.Demo}),this._createMapper(),this._setAccountBinded=this._setAccount.bind(this),i){const t=Date.now()+432e6;this._saveAccessToken({access_token:i,expiration:t}),this._setAccessTokenExpirationTimeout(t)}this._createButtonDropdownOptions(),this._customFormatters.push({name:"avgPriceFormatter",format:t=>{const e=this._priceFormatterCache.get(t.row.symbol);return e?e.format(t.value):String(t.value)}},{name:"cryptoValueInCurrencyFormatter",format:t=>`${t.row.value} ${t.row.valueCurrency}`}),this._cryptoBalanceTableChangeDelegate=this._host.factory.createDelegate()}tryRestoreSession(){this._tryRestorePreviousSession()}chartContextMenuActions(t,e){return this._host.defaultContextMenuActions(t,e)}async accountsMetainfo(){return this._accounts}setCurrentAccount(t){const e=this._accounts.find(e=>e.id===t);void 0!==e&&this._account.setValue(e)}accountManagerInfo(){const t=this._accountSummaryRowData.titles.map((t,e)=>({text:t,wValue:this._accountSummaryRowData.values[e].readonly(),formatter:this._accountSummaryRowData.formatters[e]})),e=[],s=this._ensuredConfigFlags().supportOrderBrackets||this._ensuredConfigFlags().supportPositionBrackets,o=this._ensuredConfigFlags().supportBalances;if(H(this._brokerConfig))if(o){
const t=0!==this._cryptoBalances.length?Object.keys(this._cryptoBalances[0]):h.map(t=>t.property),s=h.filter(e=>t.includes(e.property)),i=Object.assign({},{id:"cryptoBalances",name:"Balances",getData:()=>Promise.resolve(this._cryptoBalances.map(t=>K(t))),changeDelegate:this._cryptoBalanceTableChangeDelegate,columns:s});e.push(i)}else{const t=Object(r.ensure)(this._brokerConfig.accountManager).map((t,e)=>({id:t.id,title:void 0!==t.title&&t.title.length>0?t.title:Object(i.t)("Account Info"),getData:()=>Promise.resolve(this._accountManagerTablesData[e]),changeDelegate:this._accountManagerTablesDelegates[e],columns:t.columns.map(t=>({label:t.title,help:t.tooltip,property:t.id,formatter:t.formatter,notSortable:!t.sortable,tooltip:t.tooltip,isCapitalize:t.isCapitalize}))}));e.push(...t)}const n=Object(r.ensureDefined)(this._metainfo),a=this._brokerConfig.durations&&this._brokerConfig.durations.some(t=>Boolean(t.hasDatePicker||t.hasTimePicker)),c=t=>s||"stopLoss"!==t.property&&"takeProfit"!==t.property,u=t=>this._ensuredConfigFlags().supportTrailingStop||"trailingStopPrice"!==t.property,l=void 0!==n.customPositionColumnTitles&&n.customPositionColumnTitles.length>0?this._positionColumns.map(t=>{const e=Object(r.ensureDefined)(n.customPositionColumnTitles).find(e=>e.hasOwnProperty(t.property));return t.label=void 0!==e?e[Object(r.ensureDefined)(t.property)]:t.label,t}):this._positionColumns,d={accountTitle:Object(r.ensure)(this._metainfo.title),orderColumns:this._orderColumns.filter(c).filter(t=>this._brokerConfig.durations||"expiry"!==t.property).filter(t=>a||"expiryTime"!==t.property).filter(t=>this._ensuredConfigFlags().supportPartialOrderExecution||"filledQty"!==t.property).filter(u),pages:[{id:"summary",title:Object(i.t)("Account Summary"),tables:e}],positionColumns:l.filter(c).filter(t=>this._ensuredConfigFlags().supportMultiposition||"id"!==t.property).filter(u),summary:t,customFormatters:this._customFormatters};return this._ensuredConfigFlags().supportOrdersHistory&&(d.historyColumns=this._orderHistoryColumns.filter(c)),d}currentAccount(){return this._account.value().id}currentAccountType(){return 0!==this._accounts.length?this._accounts.some(t=>t.type===a.AccountType.Live)?a.AccountType.Live:a.AccountType.Demo:void 0}async executions(t){const e=this._mapFromTV(t);return null!==e&&!1===this._fetchedBrokerSymbols.has(e)&&await this._requestExecutions(e),this._tvExecutions.filter(e=>e.symbol===t)}orders(){return Promise.resolve(this._tvOrders)}async ordersHistory(){const t=await this._getOrdersHistoryByAccountId(this._account.value().id);return this._createTvOrders(t)}positions(){return Promise.resolve(this._tvPositions)}async cancelOrder(t){return b(this._getOrderIdRestUrl(t),this._getAccessToken(),m.Delete)}async modifyOrder(t,e){if(2===t.parentType)return this._modifyPositionBracketsByOrder(t);if(1===t.parentType){const s=this._tvOrderById(Object(r.ensure)(t.parentId));return W(s,t),2!==s.status?this.modifyOrder(s,e):this._modifySingleOrder(t,e)}return this._modifySingleOrder(t,e)}async placeOrder(t,e){var s
;const i=this._ensuredConfigFlags().supportDigitalSignature;let r=null;if(t.customFields){if(i){r=((null===(s=t.customFields)||void 0===s?void 0:s.digitalSignature)||this._getDigitalSignatureState()).text,this._setDigitalSignatureState(t.customFields.digitalSignature)}}else{const e=this._makeOrderDialogCustomFields(t.symbol).find(t=>t.forceUserEnterInitialValue);if(void 0!==e)throw new Error("To place order you need to select a {fieldTitle} in the order ticket.".replace("{fieldTitle}",e.title))}const o=Object.assign({},t.customFields);return delete o.digitalSignature,this._placeOrder(t,r,o,e)}async cancelOrders(t,e,s){return(()=>Promise.all(s.map(t=>this.cancelOrder(t))).then(()=>{}))()}editPositionBrackets(t,e){const s=this._getPositionIdRestUrl(t),i=Object.assign({},e);return b(s,this._getAccessToken(),m.Put,i)}reversePosition(t,e){const s=this._getPositionIdRestUrl(t),i=this._tvPositionById(t);if(void 0===i)throw new Error(`Failed to reverse position: Position ${t} not found`);const r=1===i.side?"sell":"buy",o=Object.assign({side:r},e);return b(s,this._getAccessToken(),m.Put,o)}closePosition(t,e){return b(this._getPositionIdRestUrl(t),this._getAccessToken(),m.Delete,{amount:e})}async isTradable(t){var e;const s=this._mapFromTV(t);if(null!==s){const t=this._instruments.has(s),e={tradable:t};if(!t){const t=this._getAccountWithTradableSymbol(s);null!==t&&(e.solutions={changeAccount:t.id},e.shortReason=L,e.reason=L)}return e}if(void 0!==this._metainfo.symbolPrefix){const s=t.split(":")[1],i=`${null!==(e=this._account.value().prefix)&&void 0!==e?e:this._metainfo.symbolPrefix}:${s}`,r=this._mapFromTV(i);if(null!==r){if(void 0!==this._instruments.get(r))return{tradable:!1,reason:z,shortReason:z,solutions:{changeSymbol:i}}}}return{tradable:!1}}subscribeRealtime(t){const e=this._mapFromTV(t);null!==e?(this._realtimeSubscriptions.add(e),this._subscribeQuotes(e)):this._logger.logError("Symbol not found")}unsubscribeRealtime(t){const e=this._mapFromTV(t);null!==e?(this._realtimeSubscriptions.delete(e),this._unsubscribeQuotes(e)):this._logger.logError("Symbol not found")}subscribePipValue(t){const e=this._mapFromTV(t);if(null!==e){if(!this._instrumentInfo(e).hasQuotes)return;this._pipValueSubscriptions.add(e),this._subscribeQuotes(e)}else this._logger.logError("Symbol not found")}unsubscribePipValue(t){const e=this._mapFromTV(t);null!==e?this._pipValueSubscriptions.has(e)&&(this._pipValueSubscriptions.delete(e),this._unsubscribeQuotes(e)):this._logger.logError("Symbol not found")}subscribeDOME(t){const e=this._mapFromTV(t);if(null!==e){const s=this._getDepthUrl(e),i=new F(s,m.Get,this._getHeaders(),null,this._getPullingInterval("quotes"),V),r=this._onDepthUpdate.bind(this,t);i.update.subscribe(this,r),i.start(),this._depthSubscriptions[t]={callback:r,requester:i}}else this._logger.logError("Symbol not found")}unsubscribeDOME(t){try{this._depthSubscriptions[t].requester.update.unsubscribe(this,this._depthSubscriptions[t].callback),this._depthSubscriptions[t].requester.stop(),delete this._depthSubscriptions[t]}catch(t){
this._logger.logError(Object(p.c)(t))}}async signIn(t,e,s,o){this._setStatus(2),this._host.credentialsStorage.clear(this._tokenStorageKey);try{let s;if(this._isSimplePasswordAuthorizationType()&&(s=async()=>{const s=await this._authorize(t,e);this._saveAccessToken(s),this._setAccessTokenExpirationTimeout(s.expiration)}),this._isTwoFactorAuthorizationType()){if(void 0===(null==o?void 0:o.verificationCode)){const s=await this._authorizeRequestTwoFactorCode(t,e);if(!("twoFactorMessage"in s))throw new Error(Object(i.t)("Two Factor Authorization is not configured properly"));return void this._setStatus(4,{message:s.twoFactorMessage,disconnectType:a.DisconnectType.TwoFactorRequired})}s=async()=>{const s=await this._authorizeWithTwoFactorCode(t,e,Object(r.ensureDefined)(o.verificationCode));this._saveAccessToken(s),this._setAccessTokenExpirationTimeout(s.expiration)}}await this._setAndStartLoginTasks(s),this._createButtonDropdownOptions(),this._reconnectOnFailCount=1,this._setStatus(1),this._updatePLEmitters()}catch(t){this._logger.logError("Failed to connect to broker: "+Object(p.c)(t)),this._setStatus(4,{message:Object(p.b)(t)}),this._disconnect()}}async symbolInfo(t){const e=this._mapFromTV(t);if(null!==e)return this._instrumentInfo(e);throw new Error("Symbol not found")}connectionStatus(){return this._status.value()}async disconnect(t=!1){this._disconnect(t),null!==this._loginTasks&&await this._loginTasks.terminate(),this._setStatus(3,{message:void 0,disconnectType:a.DisconnectType.LogOut})}supportFloatingPanel(){return!0}getRealtimeDataCheckParams(){return{token:this._getAccessToken()}}getVerifyLiveAccountParams(){return{token:this._getAccessToken()}}unhideSymbolSearchGroups(){return this._permittedSymbolSearchGroups}async formatter(t){return this._getPriceFormatterForSymbol(t)}async spreadFormatter(t){const e=this._mapFromTV(t);if(null!==e){const s=this._instruments.get(e);return void 0===s||"forex"!==s.type&&"cfd"!==s.type?this._host.defaultFormatter(t,!1):this._host.numericFormatter(1)}throw new Error("Symbol not found")}quantityFormatter(t){const e=this._mapFromTV(t);if(null!==e){const t=this._instruments.get(e);if(void 0!==t&&"crypto"===t.type)return this._host.quantityFormatter()}return this._host.quantityFormatter()}async previewOrder(t){const e=this._orderFromTV(t);(function(t){return"id"in t})(t)&&(e.id=t.id);const s=this._getOrderPreviewRestUrl();return void 0!==t.customFields&&Object.assign(e,t.customFields),b(s,this._getAccessToken(),m.Post,e)}async getOrderDialogOptions(t){return{customFields:this._makeOrderDialogCustomFields(t)}}getValidationRules(t){var e,s,i;const r=this._mapFromTV(t);if(null!==r)return null===(i=null===(s=null===(e=this._instruments.get(r))||void 0===e?void 0:e.ui)||void 0===s?void 0:s.validationRules)||void 0===i?void 0:i.map(t=>({...t,severity:"error"}))}async _updateMapper(t,e){return this._mapper=this._host.createMapperSync(t,e),this._mapper.ready()}async _updateAccount(t){if(void 0!==t.prefix){const e={unhideSymbolSearchGroups:this.unhideSymbolSearchGroups(),exchange:t.prefix}
;await this._updateMapper(this._metainfo.id,e)}this._saveAccountId(t),this._account.setValue(t);const e=t.durations?t.durations:this._originalBrokerConfig.durations;this._brokerConfig=Object.assign({},this._originalBrokerConfig,t.ui,{durations:e}),this._metainfo.configFlags=Object.assign(this._metainfo.configFlags,t.config),this._ensuredConfigFlags().supportStopOrdersInBothDirections&&(this._ensuredConfigFlags().supportStopOrdersInBothDirectionsInUI=!0),this._host.patchConfig(this._ensuredConfigFlags()),this._makeAccountSummaryRowData(),this._setCustomFields(t);for(const e of t.instruments)"forex"!==e.type&&"cfd"!==e.type||void 0===e.pipSize||(e.minPriceStep=Object(o.fixComputationError)(10**-Object(d.h)(e.pipSize))),this._instruments.set(e.name,e);await this._initRequesters();const s=await this._getAccountState();for(let t=0;t<Object(r.ensure)(this._brokerConfig.accountManager).length;t++){const t=this._host.factory.createDelegate();this._accountManagerTablesDelegates.push(t),this._accountManagerTablesData.push([{}])}this._setAccountManagerTableData(G(s)),this._setAccountSummaryRowData(s),this._brokerConfig.durations&&this._host.setDurations(function(t){const e=[];for(const s of t){const t={name:s.title,value:s.id,hasDatePicker:s.hasDatePicker,hasTimePicker:s.hasTimePicker};void 0!==s.supportedOrderTypes&&(t.supportedOrderTypes=s.supportedOrderTypes.map(t=>$(t))),"default"in s&&(t.default=s.default),e.push(t)}return e}(this._brokerConfig.durations)),this._changeQuotesRequesterUrl()}async _getAccounts(){const t=await b(this._getAccountsUrl(),this._getAccessToken()),e=this._metainfo.defaultAccountType||a.AccountType.Demo;if(!Array.isArray(t))throw new p.a({detailedErrorMessage:Z+": Response is not an array",userFriendlyMessage:Z});if(0===t.length)throw new p.a({detailedErrorMessage:Z+": Response is empty",userFriendlyMessage:Z});for(const s of t){const t=Y(s,["id","name","type","config"]);if(0!==t.length)throw new p.a({detailedErrorMessage:Z+": Required fields are missing: "+t.join(", "),userFriendlyMessage:Z});s.currency=s.currency||"",s.currencySign=s.currencySign||"",s.type=s.type||e}return t}async _setAccount(t){const e=1===this.connectionStatus();this._cleanup(),e&&this._setStatus(2),await this._updateAccount(t),e&&(this._setStatus(1),this._updatePLEmitters())}_updatePLEmitters(){var t;(null===(t=this._metainfo.configFlags)||void 0===t?void 0:t.supportPLUpdate)?this._stopPLEmitters():this._startPLEmitters()}_setAndStartLoginTasks(t){const e=[];return void 0!==t&&e.push(t),e.push(()=>this._getBrokerConfig().then(t=>{this._originalBrokerConfig=t}),...this._initializeAccountTasks()),this._loginTasks=new d.a(e),this._loginTasks.execute()}_startPLEmitters(){this._profitlossEmitters.forEach(t=>{t.start()})}_createOAuthAuthorizationProvider(t){let e;const s={fastRenewOauthToken:this._fastRenewOauthToken,brokerId:Object(r.ensureDefined)(this._metainfo.id),environmentType:t,logger:this._logger,passLocalesLangInOAuth:this._ensuredConfigFlags().passLocalesLangInOAuth}
;return this._isOAuthImplicitFlowAuthType()?e=new OAuth2ImplicitFlowWithRenewTokenAuthorizationProvider(s):(s.passRedirectUrl=!0,e=new OAuth2CodeFlowAuthorizationProvider(s)),e}_instrumentInfo(t){const e=this._instruments.get(t);if(!e)throw new Error("Instrument not found");const s={qty:{min:e.minQty||1,max:e.maxQty||1e9,step:e.qtyStep||1},units:e.units,pipValue:e.pipValue||1,pipSize:e.pipSize||.01,minTick:e.minTick||.01,description:e.description,brokerSymbol:t,hasQuotes:!e.hasOwnProperty("hasQuotes")||Boolean(e.hasQuotes)};return e.hasOwnProperty("lotSize")&&(s.lotSize=e.lotSize),e.hasOwnProperty("stopPriceStep")&&(s.stopPriceStep=e.stopPriceStep),e.hasOwnProperty("limitPriceStep")&&(s.limitPriceStep=e.limitPriceStep),"type"in e&&(s.type=e.type),"marginRate"in e&&(s.marginRate=e.marginRate),"baseCurrency"in e&&(s.baseCurrency=e.baseCurrency),"quoteCurrency"in e&&(s.quoteCurrency=e.quoteCurrency),s}_subscribeQuotes(t){const e=this._quotesSubscriptions.get(t),s=void 0===e?1:e+1;this._quotesSubscriptions.set(t,s),1===s&&this._changeQuotesRequesterUrl()}_unsubscribeQuotes(t){const e=this._quotesSubscriptions.get(t);if(void 0!==e)return 1===e?(this._quotesSubscriptions.delete(t),void this._changeQuotesRequesterUrl()):void this._quotesSubscriptions.set(t,e-1)}_disconnect(t=!1){this._isOAuthAuthorizationType()&&this._cleanAndDestroyOauthAuthorizationProvider(),this._cleanup(),this._cleanAccessTokenExpirationTimeout(),!1===t&&(this._host.credentialsStorage.clear(this._tokenStorageKey),this._ensuredConfigFlags().supportLogout&&this._logout()),this._account.unsubscribe(this._setAccountBinded)}_getAccessToken(){return this._accessToken}_initializeAccountTasks(){const t=[];return t.push(()=>this._getAccounts().then(t=>{this._accounts=t})),t.push(()=>Promise.all(this._accounts.map(t=>this._getInstrumentsByAccountId(t.id).then(e=>{t.instruments=e})))),this._ensuredConfigFlags().supportUnhideSymbolSearchGroups&&t.push(()=>this._getPermittedSymbolSearchGroups().then(t=>{this._permittedSymbolSearchGroups=t})),t.push(()=>this._mapper.ready()),t.push(()=>{var t;const e=null!==(t=this._getLastAccount())&&void 0!==t?t:this._accounts[0];return this._setCustomFields(e),this._setAccountBinded(e).then(()=>this._account.subscribe(this._setAccountBinded))}),t}_setCustomFields(t){var e,s,i,r,o,n;const a=null!==(s=null===(e=t.ui)||void 0===e?void 0:e.orderCustomFields)&&void 0!==s?s:this._originalBrokerConfig.orderCustomFields;t.config.supportOrderCustomFields&&void 0!==a&&(this._orderColumns=this._mergeCustomFieldColumns(c,a));const h=null!==(r=null===(i=t.ui)||void 0===i?void 0:i.orderHistoryCustomFields)&&void 0!==r?r:this._originalBrokerConfig.orderHistoryCustomFields;t.config.supportOrderHistoryCustomFields&&void 0!==h&&(this._orderHistoryColumns=this._mergeCustomFieldColumns(u,h));const d=null!==(n=null===(o=t.ui)||void 0===o?void 0:o.positionCustomFields)&&void 0!==n?n:this._originalBrokerConfig.positionCustomFields;t.config.supportPositionCustomFields&&void 0!==d&&(this._positionColumns=this._mergeCustomFieldColumns(l,d))}
_onQuotesUpdate(t){for(const e of t)if("ok"===e.s){const t=e.n,s=this._mapToTV(t);if(null!==s){const i=e.v;i.lp=i.lp||0,i.ch=i.ch||0,i.chp=i.chp||0;const n=this._instruments.get(t);if(void 0===n)throw new Error(`Instrument ${t} not found`);if(("forex"===n.type||"cfd"===n.type)&&void 0!==n.pipSize){const t=Object(r.ensureDefined)(n.minPriceStep);i.spread=Object(o.fixComputationError)((i.ask-i.bid)/t)}i.buyPipValue&&i.sellPipValue&&this._pipValueSubscriptions.has(t)&&(this._host.pipValueUpdate(s,{buyPipValue:i.buyPipValue,sellPipValue:i.sellPipValue}),n.pipValue=i.buyPipValue),this._currentQuotes.set(s,{ask:i.ask,bid:i.bid}),this._host.realtimeUpdate(s,i)}else this._logger.logError("Cannot map symbol")}}_changeQuotesRequesterUrl(){const t=this._getQuotesUrl();void 0!==this._requesters.quotes&&this._requesters.quotes.stop(),null!==t&&(void 0===this._requesters.quotes?(this._requesters.quotes=new F(t,m.Get,this._getHeaders(),null,this._getPullingInterval("quotes"),V),this._requesters.quotes.update.subscribe(this,this._onQuotesUpdate),this._requesters.quotes.statusChanged.subscribe(this,this._onRequesterStatusUpdate)):this._requesters.quotes.changeUrl(t),this._requesters.quotes.start())}_stopRequester(t){void 0!==t&&(t.stop(),t.update.unsubscribeAll(this))}async _requestExecutions(t){this._fetchedBrokerSymbols.add(t);const e=await S(this._getExecutionsUrl(t),m.Get,this._getHeaders(),null,V),s=Object(d.c)(this._restExecutions,e,"id",["id"]);for(const t of s.added){this._restExecutions.push(t);const e=await this._executionToTv(t);this._tvExecutions.push(e),this._host.executionUpdate(e)}}_createMapper(){this._mapper=this._host.createMapperSync(this._metainfo.id,{unhideSymbolSearchGroups:this.unhideSymbolSearchGroups()})}async _requestExecutionsBySymbols(t){await Promise.all(t.map(t=>this._requestExecutions(t)))}_setAccountSummaryRowData(t){var e;const s=t.hasOwnProperty("equity")&&void 0!==t.equity?t.equity:t.balance+t.unrealizedPl;if(this._ensuredConfigFlags().supportCustomAccountSummaryRow){const e=Object(r.ensureDefined)(t.accountSummaryRowData);for(let t=0;t<e.length;t++)this._accountSummaryRowData.values[t].setValue(e[t])}else this._accountSummaryRowData.values[0].setValue(t.balance),this._accountSummaryRowData.values[1].setValue(s),(null===(e=this._metainfo.configFlags)||void 0===e?void 0:e.supportPLUpdate)?this._accountSummaryRowData.values[2].setValue(t.unrealizedPl):this._updateAccountPL();isFinite(s)&&this._host.equityUpdate(s)}_setAccountManagerTableData(t){if(0!==this._accountManagerTablesData.length)for(let e=0;e<t.length;e++){const s=t[e],i=this._accountManagerTablesData[e],o=Object(r.ensure)(this._brokerConfig.accountManager)[e].columns;i.length=s.length;for(let t=0;t<s.length;t++){const n=s[t],a={id:t};for(let t=0;t<n.length;t++){a[Object(r.ensure)(o[t].id)]=n[t]}i[t]=a,this._accountManagerTablesDelegates[e].fire(a)}}}async _createRequesters(){const t=this._getOrdersRestUrl(),e=this._getAccountStateRestUrl();if(this._requesters={
orders:new A(t,m.Get,this._getHeaders(),null,this._getPullingInterval("orders"),"id",B,V,void 0,!0),accountState:new F(e,m.Get,this._getHeaders(),null,this._getPullingInterval("accountManager"),V)},this._ensuredConfigFlags().supportPositions){const t=this._getPositionsRestUrl(),e=new A(t,m.Get,this._getHeaders(),null,this._getPullingInterval("positions"),"id",R,V);e.update.subscribe(this,this._onPositionsUpdate),e.statusChanged.subscribe(this,this._onRequesterStatusUpdate),this._requesters.positions=e}if(this._ensuredConfigFlags().supportBalances){const t=this._getBalancesRestUrl(),e=new F(t,m.Get,this._getHeaders(),null,this._getPullingInterval("balances"),V);e.update.subscribe(this,this._onCryptoBalancesUpdate),e.statusChanged.subscribe(this,this._onRequesterStatusUpdate),this._requesters.balances=e}const s=Object(r.ensure)(this._requesters.orders);s.update.subscribe(this,this._onOrdersUpdate),s.statusChanged.subscribe(this,this._onRequesterStatusUpdate),Object(r.ensure)(this._requesters.accountState).update.subscribe(this,this._onAccountStateUpdate)}async _startRequesters(){const t=[];Object.keys(this._requesters).forEach(e=>t.push(Object(r.ensure)(this._requesters[e]).start())),await Promise.all(t),this._logger.logInfo("Requesters started")}_stopAndDeleteRequesters(){Object.keys(this._requesters).forEach(t=>{const e=this._requesters[t];void 0!==e&&this._stopRequester(e)}),this._requesters={}}_changeRequestersHeaders(){Object.keys(this._requesters).forEach(t=>{const e=Object(r.ensure)(this._requesters[t]);e.pause(),e.changeHeaders(this._getHeaders()),e.unpause()})}_cleanup(){this._stopAndDeleteRequesters(),this._cleanAndStopPLEmitters(),this._initData()}_cleanAndStopPLEmitters(){this._stopPLEmitters(),this._profitlossEmitters.clear()}_stopPLEmitters(){this._profitlossEmitters.forEach(t=>{t.stop()})}_setStatus(t,e){this._status.value()!==t&&(this._status.setValue(t),this._host.connectionStatusUpdate(t,e))}_onRequesterStatusUpdate(t){2===t.requesterStatus&&(this._reconnectOnFailCount<=3?(this._logger.logError(`Requester error: ${t.errorMessage}. Reconnecting count: ${this._reconnectOnFailCount++} of 3.`),this._setStatus(4,{message:t.errorMessage}),this._disconnect(!0),this._tryReconnect()):(this._logger.logError(`Requester error: ${t.errorMessage}. Maximum reconnect count reached. Disconnecting.`),this._setStatus(3,{message:t.errorMessage,disconnectType:a.DisconnectType.FailedRestoring}),this._disconnect(!1)))}_onAccountStateUpdate(t){this._setAccountSummaryRowData(t);const e=G(t);this._setAccountManagerTableData(e)}_onCryptoBalancesUpdate(t){const e=Object(d.c)(this._cryptoBalances,t,"symbol",E);[...e.added,...e.modified].forEach(t=>{const e=this._cryptoBalanceIndexBySymbol(t.symbol);-1!==e?this._cryptoBalances[e]=t:this._cryptoBalances.push(t);const s=K(t);this._cryptoBalanceTableChangeDelegate.fire(s),this._host.cryptoBalanceUpdate(t.symbol,t)}),e.removed.forEach(t=>{const e=this._cryptoBalanceIndexBySymbol(t.symbol);if(-1!==e){const s=0,i=0,r=0,o=Object.assign({},t,{total:s,available:i,btcValue:r})
;this._cryptoBalances[e]=o;const n=K(o);this._cryptoBalanceTableChangeDelegate.fire(n)}})}_cryptoBalanceIndexBySymbol(t){return this._cryptoBalances.findIndex(e=>e.symbol===t)}async _tryConnect(){const t=this._getStoredAuthResult();t&&(this._accessToken=t.access_token,this._setStatus(2),await this._setAndStartLoginTasks(),this._setAccessTokenExpirationTimeout(t.expiration),this._createButtonDropdownOptions(),this._setStatus(1),this._updatePLEmitters())}async _tryReconnect(){try{await this._tryConnect()}catch(t){this._logger.logError(Object(p.c)(t)),this._setStatus(3,{message:Object(p.b)(t),disconnectType:a.DisconnectType.FailedRestoring}),this._disconnect()}}async _tryRestorePreviousSession(){try{await this._tryConnect()}catch(t){const e=Object(p.b)(t);this._logger.logNormal("Cannot restore session: "+e),this._setStatus(3,{message:void 0,disconnectType:a.DisconnectType.FailedRestoring}),this._disconnect()}}_mergeCustomFieldColumns(t,e){const s=t.slice(),i=t.map(t=>t.property);for(const t of e){if(t.id in i){this._logger.logWarn(`Failed to add custom column. Column with id ${t.id} already exists.`);continue}const{id:e,title:o,tooltip:n,alignment:a}=t,c={label:o,property:e,help:n,notSortable:!0};void 0!==a&&(Object(r.assert)(["left","right"].includes(a),"Cell alignment must be left or right"),c.alignment=a),s.splice(-1,0,c)}return s}_authorizeRequestTwoFactorCode(t,e){return async function(t,e,s){return b(t,void 0,m.Post,{...P(e,s),twoFactorRequired:!0})}(this._getAuthorizeUrl(),t,e)}_authorizeWithTwoFactorCode(t,e,s){return async function(t,e,s,i){return b(t,void 0,m.Post,{...P(e,s),twoFactorCode:i})}(this._getAuthorizeUrl(),t,e,s)}async _authorize(t,e){return async function(t,e,s){return b(t,void 0,m.Post,{...P(e,s)})}(this._getAuthorizeUrl(),t,e)}async _getInstrumentsByAccountId(t){return b(this._getInstrumentsUrlByAccountId(t),this._getAccessToken())}async _getOrdersHistoryByAccountId(t){return b(this._getOrdersHistoryUrlByAccountId(t),this._getAccessToken())}async _getPermittedSymbolSearchGroups(){const t=await b(this._getPermissionsUrl(),this._getAccessToken());return t.hasOwnProperty("groups")?t.groups:[Object(r.ensureDefined)(this._metainfo.id)]}async _getBrokerConfig(){const t=await b(this._getBrokerConfigUrl(),this._getAccessToken());if(null===t)throw new p.a({detailedErrorMessage:X+": Response is null",userFriendlyMessage:X});return H(t)||(t.accountManager=[{id:"accountSummary",title:"",columns:[{id:"balance",title:Object(i.t)("Balance"),tooltip:"",sortable:!1},{id:"equity",title:Object(i.t)("Equity"),tooltip:"",sortable:!1},{id:"profit",title:Object(i.t)("Profit"),tooltip:"",sortable:!1}]}]),t}async _getAccountState(){return b(this._getAccountStateUrl(),this._getAccessToken())}async _placeOrder(t,e,s,i){const r=this._orderFromTV(t),o=this._getOrdersRestUrl()+"&requestId="+Object(v.randomHashN)(10);r.confirmId=i,null!==e&&(r.digitalSignature=e);const n=Object.assign(s,r);return b(o,this._getAccessToken(),m.Post,n)}async _modifyOrder(t,e,s,i){const r={id:t.id,qty:t.qty}
;void 0===t.parentId&&(t.stopLoss&&(r.stopLoss=t.stopLoss),t.trailingStopPips&&(r.trailingStopPips=t.trailingStopPips),t.takeProfit&&(r.takeProfit=t.takeProfit)),void 0!==t.duration&&(r.durationType=t.duration.type,void 0!==t.duration.datetime&&(r.durationDateTime=Math.trunc(t.duration.datetime/1e3)));const o=this._currentQuotes.get(t.symbol);void 0!==o&&(r.currentAsk=o.ask,r.currentBid=o.bid),r.limitPrice=(t.type,t.limitPrice),r.stopPrice=(t.type,t.stopPrice);const n=this._getOrderIdRestUrl(t.id);null!==e&&(r.digitalSignature=e);const a=Object.assign(s,r);a.confirmId=i,await b(n,this._getAccessToken(),m.Put,a)}async _modifySingleOrder(t,e){const s=this._ensuredConfigFlags().supportDigitalSignature,i=t.customFields&&t.customFields.digitalSignature?t.customFields.digitalSignature:this._getDigitalSignatureState(),r=s?i.text:null;null!==r&&this._setDigitalSignatureState(i);const o=Object.assign({},t.customFields);return delete o.digitalSignature,this._modifyOrder(t,r,o,e)}async _modifyPositionBracketsByOrder(t){if(void 0===this._tvPositionById(t.parentId))return;const e={...this._getPositionBrackets(t.parentId)};return 3===t.type&&(t.stopType===n.a.TrailingStop?(delete e.stopLoss,e.trailingStopPips=t.trailingStopPips):(delete e.trailingStopPips,e.stopLoss=t.stopPrice)),1===t.type&&(e.takeProfit=t.limitPrice),this.editPositionBrackets(Object(r.ensure)(t.brokerSymbol),e)}_createTvOrders(t){return t.map(t=>this._orderToTV(t))}_onOrdersUpdate(t){const e=this._createTvOrders(t.added),s=this._createTvOrders(t.modified),i=[];this._restOrders.push(...t.added);for(const e of t.modified)this._restOrders[this._restOrderIndexById(e.id)]=e;this._tvOrders.push(...e),i.push(...e);for(const t of s)this._tvOrders[this._tvOrderIndexById(t.id)]=t,i.push(t);for(const t of i){if(1===t.parentType){const e=this._tvOrderById(t.parentId);e&&(W(e,t),this._host.orderUpdate(e))}else if(2===t.parentType){const e=this._tvPositionById(t.parentId);e&&e.qty>0&&(W(e,t),this._host.positionPartialUpdate(e.id,{stopLoss:e.stopLoss,trailingStopPips:e.trailingStopPips,takeProfit:e.takeProfit}))}else if(!t.parentType){const e=this._getOrderBrackets(t.id);void 0!==e.stopLoss&&(t.stopLoss=e.stopLoss),void 0!==e.trailingStopPips&&(t.trailingStopPips=e.trailingStopPips),void 0!==e.takeProfit&&(t.takeProfit=e.takeProfit)}this._host.orderUpdate(t)}}_createTVPositions(t){return t.map(t=>this._positionToTV(t))}async _onPositionsUpdate(t){const e=[],s=this._createTVPositions(t.added),i=this._createTVPositions(t.modified);for(const e of t.added)this._addOrModifyPosition(e,this._restPositions);for(const e of t.modified)this._restPositions[this._restPositionIndexById(e.id)]=e;for(const t of s)this._updatePriceFormatterCacheForSymbol(t.symbol),this._updatePositionBrackets(t),this._host.positionUpdate(t),this._updatePositionPL(t),e.push(Object(r.ensureDefined)(t.brokerSymbol)),this._addOrModifyPosition(t,this._tvPositions);for(const t of i){const s=this._tvPositionById(t.id);if(void 0===s)return;this._updatePositionBrackets(t),this._host.positionUpdate(t),
this._updatePositionPL(t),s.side===t.side&&s.qty===t.qty||e.push(Object(r.ensureDefined)(t.brokerSymbol)),this._addOrModifyPosition(t,this._tvPositions)}t.removed.forEach(t=>{const s=this._tvPositionById(t.id);if(void 0===s)return;const i=this._restPositionById(t.id);s.qty=0,i.qty=0,e.push(Object(r.ensureDefined)(s.brokerSymbol));const o=this._makePLEmitterKey(s),n=this._profitlossEmitters.get(o);void 0!==n&&(n.stop(),this._profitlossEmitters.delete(o)),this._host.positionUpdate(s)}),this._ensuredConfigFlags().supportExecutions&&await this._requestExecutionsBySymbols(e)}_updatePositionPL(t){var e,s;if(null===(e=this._metainfo.configFlags)||void 0===e?void 0:e.supportPLUpdate){const e=this._tvPositionById(t.id);(null==e?void 0:e.unrealizedPl)!==t.unrealizedPl&&(this._host.plUpdate(t.id,t.unrealizedPl),this._host.positionPartialUpdate(t.id,{unrealizedPl:t.unrealizedPl}))}else{const e=this._makePLEmitterKey(t);if(this._profitlossEmitters.has(e))null===(s=this._profitlossEmitters.get(e))||void 0===s||s.positionUpdate(t);else{const s=e=>{this._host.plUpdate(t.id,e),this._host.positionPartialUpdate(t.id,{unrealizedPl:e})},i=t.symbol,r=this._mapper.tvToBroker(i);if(null!==r){const i=this._instrumentInfo(r),o=this._host.createPLEmitter(t,s,i);this._profitlossEmitters.set(e,o),1===this.connectionStatus()&&o.start()}else this._logger.logError(`Symbol ${i} not found`)}}}_updateAccountPL(){let t=0;this._profitlossEmitters.forEach(e=>{t+=e.lastPL()}),this._accountSummaryRowData.values[2].setValue(t)}_updatePositionBrackets(t){this._findPositionBracketOrders(t.id).forEach(e=>W(t,e))}_addOrModifyPosition(t,e){const s=e.findIndex(e=>e.id===t.id);-1!==s?e[s]=t:e.push(t)}_makePLEmitterKey(t){return this._ensuredConfigFlags().supportMultiposition?t.id:t.symbol}_restPositionIndexById(t){return this._restPositions.findIndex(e=>e.id===t)}_restPositionById(t){const e=this._restPositions.find(e=>e.id===t);if(!e)throw new Error("Cannot find REST position: "+t);return e}_restOrderIndexById(t){return this._restOrders.findIndex(e=>e.id===t)}_tvPositionById(t){return this._tvPositions.find(e=>e.id===t)}_tvOrderIndexById(t){return this._tvOrders.findIndex(e=>e.id===t)}_tvOrderById(t){const e=this._tvOrders.find(e=>e.id===t);if(!e)throw new Error("Cannot find TV order");return e}_getBaseRestUrl(){const t=this._account.value().id;return Object(r.assert)(!!t,"Unable to get base url - account is not properly initialized"),this._getBaseRestUrlByAccountId(t)}_getBaseRestUrlByAccountId(t){return`${this._restUrl}accounts/${encodeURIComponent(t)}`}_getAccountStateRestUrl(){return`${this._getBaseRestUrl()}/state?${Object(d.b)(M)}`}_getExecutionsUrl(t){const e={...M,instrument:t};return`${this._getBaseRestUrl()}/executions?${Object(d.b)(e)}`}_getPullingInterval(t){let e=x[t];if(this._brokerConfig.hasOwnProperty("pullingInterval")&&void 0!==this._brokerConfig.pullingInterval){const s=this._brokerConfig.pullingInterval;s.hasOwnProperty(t)&&(e=s[t])}return e}_getAuthorizeUrl(){return this._restUrl+"authorize"}_getBrokerConfigUrl(){
return`${this._restUrl}config?${Object(d.b)(M)}`}_getAccountsUrl(){return`${this._restUrl}accounts?${Object(d.b)(M)}`}_getAccountStateUrl(){return`${this._getBaseRestUrl()}/state?${Object(d.b)(M)}`}_getQuotesUrl(){const t=Array.from(this._quotesSubscriptions.keys()).filter(t=>this._instruments.has(t));if(0===t.length)return null;const e={...M,symbols:t.join(","),accountId:this._account.value().id};return`${this._restUrl}quotes?${Object(d.b)(e)}`}_getDepthUrl(t){const e={...M,symbol:t,accountId:this._account.value().id};return`${this._restUrl}depth?${Object(d.b)(e)}`}_getInstrumentsUrlByAccountId(t){return`${this._getBaseRestUrlByAccountId(t)}/instruments?${Object(d.b)(M)}`}_getLogoutUrl(){return this._restUrl+"logout"}_getOrdersHistoryUrlByAccountId(t){const e={...M,maxCount:200};return`${this._getBaseRestUrlByAccountId(t)}/ordersHistory?${Object(d.b)(e)}`}_getPermissionsUrl(){return this._restUrl+"permissions"}_getOrdersRestUrl(){return`${this._getBaseRestUrl()}/orders?${Object(d.b)(M)}`}_getOrderIdRestUrl(t){return`${this._getBaseRestUrl()}/orders/${t}?${Object(d.b)(M)}`}_getPositionsRestUrl(){return`${this._getBaseRestUrl()}/positions?${Object(d.b)(M)}`}_getPositionIdRestUrl(t){return`${this._getBaseRestUrl()}/positions/${t}?${Object(d.b)(M)}`}_getBalancesRestUrl(){return`${this._getBaseRestUrl()}/balances?${Object(d.b)(M)}`}_getOrderPreviewRestUrl(){return`${this._getBaseRestUrl()}/previewOrder?${Object(d.b)(M)}`}async _logout(){try{await b(this._getLogoutUrl(),this._getAccessToken(),m.Post)}catch(t){this._logger.logError("Failed to logout request: "+Object(p.c)(t))}}_getHeaders(){return y(this._getAccessToken())}_orderToTV(t){const e=this._mapToTV(t.instrument);null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument);const s={id:t.id,type:$(t.type),side:Q(t.side),symbol:e||t.instrument,brokerSymbol:t.instrument,qty:Math.abs(t.qty),filledQty:t.filledQty,status:(i=t.status,I[i]),avgPrice:t.avgPrice,limitPrice:t.limitPrice,stopPrice:t.stopPrice};var i;if(t.parentId&&(s.parentId=t.parentId,s.parentType=this._getOrderParentType(t.parentType),t.isTrailingStop&&(s.stopType=n.a.TrailingStop,s.trailingStopPips=t.trailingStopPips)),t.duration){s.duration={type:t.duration.type};const e=this._getOrderDuration(t.duration);if(Object(r.assert)(void 0!==e,"Order duration is not in durations list. Please check the broker or account duration configuration"),s.expiry=void 0!==e?e.title:t.duration.type,t.duration.hasOwnProperty("datetime")&&void 0!==t.duration.datetime){const i=1e3*t.duration.datetime;s.duration.datetime=i,s.expiryTime={dateOrDateTime:i,hasTime:Object(r.ensureDefined)(e).hasTimePicker}}}return void 0!==t.message&&(Object(d.f)(t.message.type)?s.message=t.message:this._logger.logError(`Order message type '${t.message.type}' is not supported`)),void 0!==t.lastModified&&(s.updateTime=1e3*t.lastModified),void 0!==t.customFields&&(s.customFields=this._customFieldsToTv(t.customFields)),this._mergeCustomFields(t,s),s}_getOrderParentType(t){return"position"===t?2:1}_customFieldsToTv(t){const e={}
;for(const s of t)e[s.id]=s.value;return e}_mergeCustomFields(t,e){if(void 0!==t.customFields)for(const s of t.customFields)e[s.id]=s.value}_getOrderDuration(t){return Object(r.ensureDefined)(this._brokerConfig.durations).find(e=>e.id===Object(r.ensureDefined)(t).type)}_orderFromTV(t){var e,s;const i=this._mapFromTV(t.symbol);if(null!==i){const a={instrument:i,qty:t.qty,side:(n=t.side,-1===n?"sell":"buy"),type:(o=t.type,D[o=o||2]),limitPrice:t.limitPrice,stopPrice:t.stopPrice};t.stopLoss&&(a.stopLoss=t.stopLoss),t.trailingStopPips&&(a.trailingStopPips=t.trailingStopPips),t.takeProfit&&(a.takeProfit=t.takeProfit),t.duration&&(a.durationType=t.duration.type,t.duration.datetime&&(a.durationDateTime=Math.trunc(t.duration.datetime/1e3)));const c=this._currentQuotes.get(t.symbol);return void 0===c&&null===t.seenPrice||(a.currentAsk=Object(r.ensure)(null!==(e=null==c?void 0:c.ask)&&void 0!==e?e:t.seenPrice),a.currentBid=Object(r.ensure)(null!==(s=null==c?void 0:c.bid)&&void 0!==s?s:t.seenPrice)),a}throw new Error("Cannot map symbol: "+t.symbol);var o,n}_getBrackets(t){const e={};for(const s of t)3===s.type&&(s.stopType===n.a.TrailingStop?e.trailingStopPips=s.trailingStopPips:e.stopLoss=s.stopPrice),1===s.type&&(e.takeProfit=s.limitPrice);return e}_getOrderBrackets(t){const e=this._tvOrders.filter(e=>1===e.parentType&&e.parentId===t&&1!==e.status&&2!==e.status);return this._getBrackets(e)}_findPositionBracketOrders(t){return this._tvOrders.filter(e=>2===e.parentType&&e.parentId===t&&6===e.status)}_getPositionBrackets(t){const e=this._findPositionBracketOrders(t);return this._getBrackets(e)}_executionToTv(t){const e=this._mapToTV(t.instrument);return null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument),{id:t.id,symbol:e||"",brokerSymbol:t.instrument,price:t.price,qty:t.qty,side:Q(t.side),time:1e3*t.time,orderId:t.orderId,isClose:t.isClose,positionId:t.positionId,commission:t.commission}}_positionToTV(t){const e=this._mapToTV(t.instrument);null===e&&this._logger.logWarn("Cannot map symbol: "+t.instrument);const s={id:t.id,symbol:e||t.instrument,brokerSymbol:t.instrument,qty:Math.abs(t.qty),side:"buy"===t.side?1:-1,avgPrice:t.avgPrice,realizedPl:t.realizedPl,currency:this._account.value().currency};return void 0!==t.message&&(Object(d.f)(t.message.type)?s.message=t.message:this._logger.logError(`Position message type '${t.message.type}' is not supported`)),this._ensuredConfigFlags().supportPartialOrderExecution&&(s.filledQty=t.filledQty),this._ensuredConfigFlags().supportPLUpdate&&(s.unrealizedPl=t.unrealizedPl),this._tvOrders.filter(t=>2===t.parentType&&t.parentId===s.id).forEach(t=>W(s,t)),this._mergeCustomFields(t,s),s}_mapToTV(t){return this._mapper.brokerToTv(t)}_mapFromTV(t){return this._mapper.tvToBroker(t)}_initData(){this._accountManagerTablesDelegates=[],this._accountManagerTablesData=[],this._restExecutions=[],this._tvExecutions=[],this._restOrders=[],this._tvOrders=[],this._restPositions=[],this._tvPositions=[],this._instruments.clear(),this._priceFormatterCache.clear(),this._currentQuotes.clear(),
this._cryptoBalances=[],this._accountSummaryRowData={titles:[],values:[],formatters:[]}}_createButtonDropdownOptions(){const t=this._host.defaultDropdownMenuActions({tradingProperties:!0});this._host.setButtonDropdownActions(t)}async _initRequesters(){this._accounts.length>0&&(await this._createRequesters(),await this._startRequesters())}_getStoredAuthResult(){return this._host.credentialsStorage.load(this._tokenStorageKey)}_setAccessTokenExpirationTimeout(t){if(null===t)return;let e,s=this._checkAccessTokenExpiration.bind(this);e=1e3*Object(r.ensureDefined)(t)-Date.now().valueOf(),e<0?this._checkAccessTokenExpiration():(s=this._checkAccessTokenExpiration.bind(this),e+=1e4,this._accessTokenExpirationTimeout=setTimeout(s,e))}_saveAccessToken(t){this._host.credentialsStorage.save(this._tokenStorageKey,t),this._accessToken=t.access_token}_checkAccessTokenExpiration(){const t=this._getStoredAuthResult();if(t&&1e3*Object(r.ensureNotNull)(t.expiration)<=Date.now().valueOf()){const t=Object(i.t)("Access token has expired");this._logger.logError(t),this._setStatus(4,{message:t,disconnectType:a.DisconnectType.LogOut}),this._disconnect()}}_onDepthUpdate(t,e){const s={snapshot:!0,asks:N(e.asks),bids:N(e.bids)};this._host.domeUpdate(t,s)}_getAccountWithTradableSymbol(t){let e=null;for(const s of this._accounts)if(-1!==s.instruments.findIndex(e=>t===e.name)){e=s;break}return e}async _createPriceFormatter(t){try{if(await this._host.isFractional(t))return await this._host.defaultFormatter(t,!0);const e=this._mapFromTV(t);if(null===e)throw new Error("Symbol not found");const s=this._instruments.get(e);if(void 0===s)throw new Error("Instrument not found");const i=Math.pow(10,Object(d.h)(s.minTick)),r=s.minTick*i;return this._host.factory.createPriceFormatter(i,r,!1)}catch(e){return this._logger.logWarn(`Failed to create price formatter for symbol ${t}.`),this._host.factory.createPriceFormatter()}}async _getPriceFormatterForSymbol(t){let e=this._priceFormatterCache.get(t);return e||(e=await this._createPriceFormatter(t),this._priceFormatterCache.set(t,e)),e}async _updatePriceFormatterCacheForSymbol(t){if(!this._priceFormatterCache.has(t)){this._priceFormatterCache.set(t,null);const e=await this._createPriceFormatter(t);this._priceFormatterCache.set(t,e),this._tvPositions.filter(e=>e.symbol===t&&e.qty>0).forEach(t=>this._host.positionUpdate(t))}}_getAccountById(t){return this._accounts.find(e=>e.id===t)}_saveAccountId(t){this._host.settings.save(this._lastAccountIdKey,JSON.stringify(t.id))}_getLastAccount(){const t=this._host.settings.load(this._lastAccountIdKey,void 0);return void 0!==t?this._getAccountById(JSON.parse(t)):void 0}_isTwoFactorAuthorizationType(){return"password"===this._ensuredConfigFlags().authorizationType&&Boolean(this._ensuredConfigFlags().supportTwoFactorAuthorization)}_isSimplePasswordAuthorizationType(){return"password"===this._ensuredConfigFlags().authorizationType&&!this._ensuredConfigFlags().supportTwoFactorAuthorization}_isOAuthAuthorizationType(){
return this._isOAuthCodeFlowAuthType()||this._isOAuthImplicitFlowAuthType()}_isOAuthImplicitFlowAuthType(){return"oauth2-implicit-flow"===this._ensuredConfigFlags().authorizationType}_isOAuthCodeFlowAuthType(){return"oauth2-code-flow"===this._ensuredConfigFlags().authorizationType}_makeDigitalSignatureCustomField(){return{inputType:"TextWithCheckBox",id:"digitalSignature",title:Object(i.t)("Digital Signature"),placeHolder:Object(i.t)("Enter your personal digital signature"),value:this._getDigitalSignatureState(),customInfo:{checkboxTitle:Object(i.t)("Save"),asterix:!0}}}_setDigitalSignatureState(t){const e=t.checked?t:U;this._host.credentialsStorage.save("digital-signature-state",e)}_getDigitalSignatureState(){const t=this._host.credentialsStorage.load("digital-signature-state");return null!==t?t:U}_makeAccountSummaryRowData(){let t=[],e=[];const s=[];if(this._ensuredConfigFlags().supportCustomAccountSummaryRow&&void 0!==this._brokerConfig.accountSummaryRow)for(const i of this._brokerConfig.accountSummaryRow)t.push(i.title),e.push(this._host.factory.createWatchedValue()),s.push("default");else t=[Object(i.t)("Account Balance"),Object(i.t)("Equity",{context:"trading"}),Object(i.t)("Profit")],e=[this._host.factory.createWatchedValue(),this._host.factory.createWatchedValue(),this._host.factory.createWatchedValue()],s.fill("fixed",0,2);this._accountSummaryRowData.titles=t,this._accountSummaryRowData.values=e,this._accountSummaryRowData.formatters=s}_cleanAccessTokenExpirationTimeout(){null!==this._accessTokenExpirationTimeout&&(clearTimeout(this._accessTokenExpirationTimeout),this._accessTokenExpirationTimeout=null)}_cleanAndDestroyOauthAuthorizationProvider(){null!==this._oAuthAuthorizationProvider&&(this._oAuthAuthorizationProvider.renewTokenDelegate().unsubscribe(this,this._onRenewAccessTokenHandler),this._oAuthAuthorizationProvider.destroy(),this._oAuthAuthorizationProvider=null)}_onRenewAccessTokenHandler(t){if(null===t)return this._setStatus(3),void this._disconnect();this._saveAccessToken(t),this._changeRequestersHeaders()}_ensuredConfigFlags(){return Object(r.ensureDefined)(this._metainfo.configFlags)}_makeAccountOrderDialogCustomFields(t){var e,s;return(null===(s=null===(e=t.ui)||void 0===e?void 0:e.orderDialogCustomFields)||void 0===s?void 0:s.comboBox)?J(t.ui.orderDialogCustomFields.comboBox):[]}_makeInstrumentOrderDialogCustomFields(t){var e,s;const i=this._mapFromTV(t);if(null===i)return[];const r=null===(s=null===(e=this._instruments.get(i))||void 0===e?void 0:e.ui)||void 0===s?void 0:s.orderDialogCustomFields;return void 0!==r?J(r.comboBox):[]}_makeOrderDialogCustomFields(t){const e=this._makeInstrumentOrderDialogCustomFieldsMemoized(t),s=this._makeAccountOrderDialogCustomFieldsMemoized(this._account.value()),i=[...e.length>0?e:s];return this._ensuredConfigFlags().supportDigitalSignature&&i.push(this._makeDigitalSignatureCustomField()),i}}}}]);