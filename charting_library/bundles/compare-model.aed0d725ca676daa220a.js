(window.webpackJsonp=window.webpackJsonp||[]).push([["compare-model"],{TgrR:function(e,t,n){"use strict";function s(e){if(e.fullName)return e.fullName;let t;return t=e.prefix||e.exchange?(e.prefix||e.exchange)+":"+e.name:e.name,t.replace(/<\/?[^>]+(>|$)/g,"")}function o(e){return""===e.value}function r(){const e=c();return e.find(o)||e[0]||null}function i(){return c()}function c(){return window.ChartApiInstance.supportedExchangesList().map(e=>({...e,country:"",providerId:"",flag:""}))}function d(){return window.ChartApiInstance.supportedSymbolsTypes()}function a(){return""}function l(){return!1}n.d(t,"f",(function(){return s})),n.d(t,"g",(function(){return o})),n.d(t,"e",(function(){return r})),n.d(t,"c",(function(){return i})),n.d(t,"d",(function(){return d})),n.d(t,"b",(function(){return a})),n.d(t,"a",(function(){return l}))},cK0E:function(e,t,n){"use strict";n.r(t);var s=n("Eyy1"),o=n("Kxc7"),r=n("jy4L"),i=n("5fI3"),c=n("hY0g"),d=n.n(c),a=n("xlAh"),l=n("cKqi"),h=n("YzC7"),u=n("qC62"),m=n("TgrR");new Set(["short_name","description","exchange","type","country_code","provider_id"]);const y=Object(m.c)(),_={};for(const e of y)_[e.value]={country:e.country,providerId:e.providerId};function f(e){return e instanceof l.study_Overlay||e instanceof h.a}function b(e){if(!e)return;const[t,n]=e.split(":");return n&&t&&_[t]?_[t]:void 0}function S(e,t,n){const s=u.a.fromSymbolInfo(e),o=b(s);return{id:(null==n?void 0:n.id())||s,symbol:s,checked:t,title:e.name,description:e.description,exchangeName:e.exchange,country:null==o?void 0:o.country,providerId:null==o?void 0:o.providerId,marketType:e.type,study:n}}function p(e,t,n,s){return{id:void 0!==n?n.id():e,symbol:e,checked:t,title:e,study:n,description:s}}var g=n("Vdly"),v=n("QN5O"),I=n("1pWb");n.d(t,"CompareModel",(function(){return k}));class k{constructor(e){this._contentItemList=new d.a([]),this._checkedSymbols=new Map,this._recentLength=10,this._adapter=v.a.get("compare-dialog-adapter"),this._isDataReady=new d.a(!1),this._highlightedSymbol=new d.a(null),this._defaultSymbolsDescriptions=new Map,this._idToStudyMap=new Map,this._chartSession=null,this._recentSymbolsEnabled=o.enabled("compare_recent_symbols_enabled"),this._preventHandleSourcesChange=!0,this.removeStudy=e=>{const{symbol:t,study:n}=e;if(!n)return;this._chartWidget.model().removeSource(n,!1);const s=this._checkedSymbols.get(t);s&&s.length>1?this._removeStudyIdFromCheckedSymbols(t,n.id()):this._checkedSymbols.delete(t),this._updateContentItemList(this._contentItemList.value(),!0)},this._getResolveSymbolPromise=(e,t=Object(r.makeNextSymbolId)())=>{const n=Object(i.encodeExtendedSymbolOrGetSimpleSymbolString)({symbol:e});return new Promise(e=>{Object(s.ensureNotNull)(this._chartSession).resolveSymbol(t,n,t=>{e(t)})})},this._chartWidget=e.activeChartWidget.value(),this._chartSession=this._chartWidget.model().model().chartApi();const t=new Set(this._loadRecent().reverse()),n=new Set,c=new Set,a=this._chartWidget.model().model().dataSources().filter(f),l=a.map(e=>{const t=e.symbolInfo()
;if(t)return Promise.resolve(u.a.fromSymbolInfo(t));const n=e.symbol();return Object(u.b)(n)});Promise.all(l).then(e=>{const s=e.map((e,t)=>void 0!==e?a[t]:void 0).filter(w);e.filter(w).forEach((e,o)=>{const r=s[o],i=r.id();this._addStudyIdToCheckedSymbols(e,i),this._idToStudyMap.set(i,r),t.has(e)?n.add(e):c.add(e)});const o=Array.from(t).filter(e=>this._checkedSymbols.has(e)).reduce((e,t)=>(n.has(t)&&e.push(t),e),[]).concat(Array.from(c)),i=Array.from(t);if(i.length<this._recentLength){let e;e=[],this._chartWidget.compareSymbols()&&this._chartWidget.compareSymbols().forEach(t=>{e.push(Object(u.b)(t.symbol)),this._defaultSymbolsDescriptions.set(t.symbol,t.title)});const t=[...i,...e];o.push(...t)}else o.push(...i);const d=Array.from(new Set(o));{const e=new Map,t=d.map(t=>{const n=Object(r.makeNextSymbolId)();return e.set(t,n),this._getResolveSymbolPromise(t,n)});Promise.all(t).then(t=>this._handleInitProcess(o,n=>{const s=e.get(n);return t.find(e=>e.params[0]===s)},(e,t)=>u.a.fromSymbolMessage(t,e),(e,t,n,s)=>"symbol_resolved"===e.method?S(e.params[1],n,s):p(t,n,s,this._getSymbolDescription(t))))}})}chartModel(){return this._chartWidget.model().model()}handleSourcesChange(){if(this._preventHandleSourcesChange)return;const e=this.chartModel().dataSources().filter(f),t=new Set(e.map(e=>e.id()));Array.from(t).forEach(e=>{if(!this._checkedStudiesIds().has(e)){const t=this.chartModel().dataSourceForId(e)||null;if(null!==t&&f(t)){const t=this._getContentItemByStudyId(e);if(!t)return;this._addStudyIdToCheckedSymbols(t.symbol,e),this._saveRecent(t.symbol),this._updateContentItemList(this._contentItemList.value(),!0)}}});Array.from(this._checkedStudiesIds()).forEach(e=>{if(!t.has(e)){const t=this._getContentItemByStudyId(e);if(!t)return;const n=this._checkedSymbols.get(t.symbol);n&&n.length>1?this._removeStudyIdFromCheckedSymbols(t.symbol,e):this._checkedSymbols.delete(t.symbol),this._updateContentItemList(this._contentItemList.value(),!0)}})}studies(){return this._contentItemList.readonly()}isDataReady(){return this._isDataReady.readonly()}highlightedSymbol(){return this._highlightedSymbol.readonly()}applyStudy(e,t,n){const s=this._chartWidget;if(!s)return;if(Object(I.b)(e))return;let o;switch(t){case a.a.SameScale:o=s.addCompareAsOverlay(e,n);break;case a.a.NewPriceScale:o=s.addOverlayStudy(e,!0,n);break;case a.a.NewPane:o=s.addOverlayStudy(e,!1,n)}Promise.all([this._getResolveSymbolPromise(e),o]).then(t=>this._handleApplyProcess(t,t=>u.a.fromSymbolMessage(e,t),(e,t,n)=>"symbol_resolved"===e.method?S(e.params[1],!0,n):p(t,!0,n)))}_handleApplyProcess(e,t,n){const[s,o]=e;if(!s||null===o)return;const r=o.id(),i=t(s),c=n(s,i,o);this._saveRecent(i),this._addStudyIdToCheckedSymbols(i,r),this._showNewItem(c,i,r)}_handleInitProcess(e,t,n,s){const o=[];for(const r of e){const e=t(r);if(!e)continue;const i=n(e,r),c=this._checkedSymbols.get(i),d=-1!==o.findIndex(e=>e.symbol===i);if(void 0===c||d)this._recentSymbolsEnabled&&o.push(s(e,i,!1));else for(const t of c)o.push(s(e,i,!0,this._idToStudyMap.get(t)))}
this._updateContentItemList(o),this._isDataReady.setValue(!0)}_showNewItem(e,t,n){const s=this._contentItemList.value().map(this._updateChecked,this);s.unshift(e),this._recentSymbolsEnabled&&s.unshift({...e,id:t,study:void 0,checked:!1}),this._updateContentItemList(s),this._highlightedSymbol.setValue(n),setTimeout(()=>this._highlightedSymbol.setValue(null),500)}_addStudyIdToCheckedSymbols(e,t){const n=this._checkedSymbols.get(e)||[];this._checkedSymbols.set(e,[...n,t])}_removeStudyIdFromCheckedSymbols(e,t){const n=this._checkedSymbols.get(e);if(n){const s=n.indexOf(t);n.splice(s,1),this._checkedSymbols.set(e,n)}}_updateChecked(e){var t;const n=this._checkedSymbols.get(e.symbol),s=null===(t=e.study)||void 0===t?void 0:t.id();return s?{...e,checked:Boolean(n&&n.includes(s))}:e}_updateContentItemList(e,t){const n=t?e.map(this._updateChecked,this):e,s=n.filter(e=>e.checked);if(this._recentSymbolsEnabled){const e=new Set,t=n.reduce((t,n)=>(n.checked||e.has(n.symbol)||(t.push(n),e.add(n.symbol)),t),[]).slice(0,this._recentLength);this._contentItemList.setValue(s.concat(t))}else this._contentItemList.setValue(s)}_checkedStudiesIds(){const e=[].concat(...Array.from(this._checkedSymbols.values()));return new Set(e)}_getContentItemByStudyId(e){const t=this._contentItemList.value(),n=t.findIndex(t=>t.study&&t.study.id()===e);return t[n]}_loadRecent(){return this._recentSymbolsEnabled?g.getJSON("CompareDialog.recent",[]):[]}_saveRecent(e){if(!this._recentSymbolsEnabled)return;const t=new Set(this._loadRecent());t.has(e)&&t.delete(e),t.add(e),g.setJSON("CompareDialog.recent",Array.from(t).slice(-this._recentLength))}_getSymbolDescription(e){var t;return this._defaultSymbolsDescriptions.size&&null!==(t=this._defaultSymbolsDescriptions.get(e))&&void 0!==t?t:""}}function w(e){return void 0!==e}},qC62:function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return s}));var s,o=n("Eyy1"),r=n("Kxc7");n("TgrR");function i(e){return e}!function(e){function t(e){return e.pro_name}function n(e){{const t=r.enabled("pay_attention_to_ticker_not_symbol")?e.ticker:e.full_name;return Object(o.ensureDefined)(t)}}e.fromQuotesResponse=function(e){const{values:n,symbolname:s,status:o}=e;return"error"===o&&s?s:t(n)},e.fromQuotes=t,e.fromSymbolSearchResult=function(e,t){{const{ticker:n,full_name:s}=null!=t?t:e;return r.enabled("pay_attention_to_ticker_not_symbol")?Object(o.ensureDefined)(null!=n?n:s):Object(o.ensureDefined)(s)}},e.fromSymbolInfo=n,e.fromSymbolMessage=function(e,t){return"symbol_resolved"===t.method?n(t.params[1]):e}}(s||(s={}))},xlAh:function(e,t,n){"use strict";var s;n.d(t,"a",(function(){return s})),function(e){e[e.SameScale=0]="SameScale",e[e.NewPriceScale=1]="NewPriceScale",e[e.NewPane=2]="NewPane"}(s||(s={}))}}]);